<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sh.mapper.AdminRevMapper">

	<!-- void deleteCheckedByNo(String revNo); -->
	<delete id="deleteCheckedByNo" parameterType="string">
		delete from sh_room_rev
		where room_rev_no = #{revNo}
	</delete>

	<!-- void updateRoomRevDetailByNo(RoomRev roomRev); -->
	<update id="updateRoomRevDetailByNo" parameterType="com.sh.web.form.AdminRoomRevUpdateForm">
		update sh_room_rev
		set
			room_rev_adult = to_number(#{adult}),
			room_rev_child = to_number(#{child}),
			room_rev_total_price = #{priceInt},
			room_rev_checkin_time = to_date(#{checkinDate}),
			room_rev_checkout_time = to_date(#{checkoutDate}),
			room_rev_request = #{request},
			room_rev_status = #{status},
			room_rev_option_checkin_time = #{timeOption},
			room_rev_updated_date = sysdate
		where room_rev_no = to_number(#{no})	
	</update>

	<resultMap type="RoomRev" id="RoomRevResultMap">
		<id column="room_rev_no" property="no"/>
		<result column="room_rev_adult" property="adult"/>
		<result column="room_rev_child" property="child"/>
		<result column="room_rev_total_price" property="totalPrice"/>
		<result column="room_rev_checkin" property="checkin"/>
		<result column="room_rev_checkout" property="checkout"/>
		<result column="room_rev_checkin_time" property="checkinTime"/>
		<result column="room_rev_checkout_time" property="checkoutTime"/>
		<result column="room_rev_request" property="request"/>
		<result column="room_rev_status" property="status"/>
		<result column="room_rev_option_checkin_time" property="optionCheckinTime"/>
		<result column="room_rev_created_date" property="createdDate"/>
		<result column="room_rev_updated_date" property="updatedDate"/>
		<association property="user" column="user_no" select="com.sh.mapper.UserMapper.getUserByNo"></association>
		<association property="room" column="room_id" select="com.sh.mapper.RoomMapper.getRoomById"></association>
	</resultMap>
	
	<!-- List<RoomRev> getPeriodByNo(int revNo); -->
	<select id="getPeriodByNo" parameterType="int" resultMap="RoomRevResultMap">
		select *
		from sh_room_rev
		where room_id = (select room_id
                 		 from sh_room_rev
                 		 where room_rev_no = #{revNo})
	</select>

	<!-- RoomRev getRoomRevDetailByNo(int no); -->
	<select id="getRoomRevDetailByNo" parameterType="int" resultMap="RoomRevResultMap">
		select *
		from sh_room_rev
		where room_rev_no = #{revNo}
	</select>
	
	<!-- RoomRev getAllRoomRevList(); 예약현황 페이지 첫 진입시 전체 리스트 뿌리기 -->
	<select id="getAllRoomRevList" parameterType="Pagination" resultMap="RoomRevResultMap">
		select *
		from (select row_number() over (order by room_rev_no desc) row_number, V.*
			  from sh_room_rev V)
	    where row_number &gt;= #{beginIndex} and row_number &lt;= #{endIndex}
	</select>
	
	<!-- int getTotalRows(); 페이징처리 총 개수 반환-->
	<select id="getTotalRows" resultType="int">
	 	select count(*)
	 	from sh_room_rev
	</select>
	
	<!-- int getTotalRowsByFilter(AdminRoomRevCriteria adminRoomRevCriteria); -->	
	<select id="getTotalRowsByFilter" parameterType="AdminRoomRevCriteria" resultType="int">
		select count(*)
		from sh_room_rev
		<where>
			<if test='search == "name"'>
			    user_no in (select user_no
		                    from sh_users
		                    where user_name like '%'||#{keyword}||'%')
			</if>
			<if test='search == "revNo"'>
				and room_rev_no like '%'||#{keyword}||'%'
			</if>
			<if test="location != 0">
		 		and room_id in (select room_id
		                    	from sh_room
		                    	where location_no = #{locationNo})
			</if>
			<if test="roomCategory != 0">
			    and room_id in (select room_id 
		                 	    from sh_room
		                        where room_category_no in (select g.room_category_no
			                                               from sh_room_category g, sh_room_category c
			                                               where g.room_group_no = c.room_category_no
			                                               and g.room_group_no = #{roomCategoryNo}))
			</if>
			<if test="revStatus != null">
				and room_rev_status = #{revStatus}
			</if>
			<if test='checkinPeriod != null and checkinPeriod != ""'>
				and room_rev_checkin_time between to_date(#{inStartDate}) and to_date(#{inEndDate})
			</if>
		</where>	  
	</select>
	
	<!-- List<RoomRev> filterRev(AdminRoomRevCriteria adminRoomRevCriteria); -->
	<select id="filterRev" parameterType="AdminRoomRevCriteria" resultMap="RoomRevResultMap">
		select *
		from (select row_number() over
		<choose>	
			<when test='sortRev == null and sortCheckin == null'>
				(order by room_rev_no desc)
			</when>
			<when test='sortRev == "desc" and sortCheckin == "desc"'>
				(order by room_rev_no desc, room_rev_checkin_time desc)
			</when>
			<when test='sortRev == "desc" and sortCheckin == "asc"'>
				(order by room_rev_no desc, room_rev_checkin_time asc)
			</when>
			<when test='sortRev == "asc" and sortCheckin == "desc"'>
				(order by room_rev_no asc, room_rev_checkin_time desc)
			</when>
			<when test='sortRev == "asc" and sortCheckin == "asc"'>
				(order by room_rev_no asc, room_rev_checkin_time asc)
			</when>
			<when test='sortRev == null and sortCheckin == "asc"'>
				(order by room_rev_checkin_time asc)
			</when>
			<when test='sortRev == null and sortCheckin == "desc"'>
				(order by room_rev_checkin_time desc)
			</when>
			<when test='sortRev == "asc" and sortCheckin == null'>
				(order by room_rev_no asc)
			</when>
			<when test='sortRev == "desc" and sortCheckin == null'>
				(order by room_rev_no desc)
			</when>	
		</choose>
			row_number, V.*
			from sh_room_rev V
		<where>
			<if test='search == "name"'>
			    user_no in (select user_no
		                    from sh_users
		                    where user_name like '%'||#{keyword}||'%')
			</if>
			<if test='search == "revNo"'>
				and room_rev_no like '%'||#{keyword}||'%'
			</if>
			<if test="location != 0">
		 		and room_id in (select room_id
		                    	from sh_room
		                    	where location_no = #{locationNo})
			</if>
			<if test="roomCategory != 0">
			    and room_id in (select room_id 
		                 	    from sh_room
		                        where room_category_no in (select g.room_category_no
			                                               from sh_room_category g, sh_room_category c
			                                               where g.room_group_no = c.room_category_no
			                                               and g.room_group_no = #{roomCategoryNo}))
			</if>
			<if test="revStatus != null">
				and room_rev_status = #{revStatus}
			</if>
			<if test='checkinPeriod != null and checkinPeriod != ""'>
				and room_rev_checkin_time between to_date(#{inStartDate}) and to_date(#{inEndDate})
			</if>
		</where>	  
			  )
		<where>
				row_number &gt;= #{beginIndex} and row_number &lt;= #{endIndex}
		</where>
	</select>
	
	
</mapper>